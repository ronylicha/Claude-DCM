openapi: 3.1.0
info:
  title: DCM API
  version: 3.0.0
  description: Distributed Context Manager for Claude Code multi-agent sessions
  contact:
    name: DCM Support
  license:
    name: MIT

servers:
  - url: http://localhost:3847
    description: Development server
  - url: http://127.0.0.1:3847
    description: Development alternative
  - url: https://api.dcm.example.com
    description: Production server

tags:
  - name: health
    description: System health and status
  - name: dashboard
    description: Dashboard KPIs and metrics
  - name: projects
    description: Project management
  - name: requests
    description: Request management
  - name: tasks
    description: Task management
  - name: subtasks
    description: Subtask management
  - name: actions
    description: Action tracking
  - name: routing
    description: Agent routing suggestions
  - name: hierarchy
    description: Hierarchical views
  - name: context
    description: Context management and generation
  - name: compact
    description: Context compaction and snapshots
  - name: agent-contexts
    description: Agent context metadata
  - name: sessions
    description: Session management
  - name: messages
    description: Inter-agent messaging
  - name: subscriptions
    description: Message subscriptions
  - name: blocking
    description: Agent blocking
  - name: cleanup
    description: Cleanup operations
  - name: tools
    description: Tools summary
  - name: auth
    description: Authentication and tokens
  - name: tokens
    description: Token tracking and capacity
  - name: registry
    description: Agent registry
  - name: orchestration
    description: Batch orchestration
  - name: waves
    description: Wave management

paths:
  /health:
    get:
      tags:
        - health
      summary: Health check
      operationId: getHealth
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [healthy, unhealthy]
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                  database:
                    type: object
                    properties:
                      healthy:
                        type: boolean
                      error:
                        type: string
                  features:
                    type: object
                    properties:
                      phase1:
                        type: string
                      phase2:
                        type: string
                      phase3:
                        type: string
                      phase4:
                        type: string
                      phase5:
                        type: string
                      phase6:
                        type: string
                      phase7:
                        type: string
                      phase8:
                        type: string
                      phase9:
                        type: string
        '503':
          description: Server is unhealthy

  /stats:
    get:
      tags:
        - health
      summary: Get database statistics
      operationId: getStats
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  timestamp:
                    type: string
                    format: date-time
        '500':
          description: Failed to get stats

  /api/dashboard/kpis:
    get:
      tags:
        - dashboard
      summary: Get dashboard KPIs
      operationId: getDashboardKpis
      responses:
        '200':
          description: Dashboard KPIs
          content:
            application/json:
              schema:
                type: object

  /api/projects:
    post:
      tags:
        - projects
      summary: Create project
      operationId: postProject
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - path
              properties:
                name:
                  type: string
                path:
                  type: string
                description:
                  type: string
                metadata:
                  type: object
      responses:
        '201':
          description: Project created
          content:
            application/json:
              schema:
                type: object
        '400':
          description: Invalid request

    get:
      tags:
        - projects
      summary: List all projects
      operationId: getProjects
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Projects list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/projects/by-path:
    get:
      tags:
        - projects
      summary: Get project by path
      operationId: getProjectByPath
      parameters:
        - name: path
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Project found
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Project not found

  /api/projects/{id}:
    get:
      tags:
        - projects
      summary: Get project by ID
      operationId: getProjectById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Project found
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Project not found

    delete:
      tags:
        - projects
      summary: Delete project
      operationId: deleteProject
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Project deleted
        '404':
          description: Project not found

  /api/requests:
    post:
      tags:
        - requests
      summary: Create request
      operationId: postRequest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - project_id
              properties:
                project_id:
                  type: string
                user_query:
                  type: string
                context:
                  type: object
      responses:
        '201':
          description: Request created

    get:
      tags:
        - requests
      summary: List requests
      operationId: getRequests
      parameters:
        - name: project_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Requests list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/requests/{id}:
    get:
      tags:
        - requests
      summary: Get request by ID
      operationId: getRequestById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Request found
        '404':
          description: Request not found

    patch:
      tags:
        - requests
      summary: Update request
      operationId: patchRequest
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Request updated
        '404':
          description: Request not found

    delete:
      tags:
        - requests
      summary: Delete request
      operationId: deleteRequest
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Request deleted
        '404':
          description: Request not found

  /api/tasks:
    post:
      tags:
        - tasks
      summary: Create task
      operationId: postTask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - request_id
              properties:
                request_id:
                  type: string
                title:
                  type: string
                description:
                  type: string
                status:
                  type: string
      responses:
        '201':
          description: Task created

    get:
      tags:
        - tasks
      summary: List tasks
      operationId: getTasks
      parameters:
        - name: request_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Tasks list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/tasks/{id}:
    get:
      tags:
        - tasks
      summary: Get task by ID
      operationId: getTaskById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Task found
        '404':
          description: Task not found

    patch:
      tags:
        - tasks
      summary: Update task
      operationId: patchTask
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Task updated
        '404':
          description: Task not found

    delete:
      tags:
        - tasks
      summary: Delete task
      operationId: deleteTask
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Task deleted
        '404':
          description: Task not found

  /api/subtasks:
    post:
      tags:
        - subtasks
      summary: Create subtask
      operationId: postSubtask
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - task_id
              properties:
                task_id:
                  type: string
                title:
                  type: string
                description:
                  type: string
                agent_type:
                  type: string
      responses:
        '201':
          description: Subtask created

    get:
      tags:
        - subtasks
      summary: List subtasks
      operationId: getSubtasks
      parameters:
        - name: task_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Subtasks list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/subtasks/close-session:
    post:
      tags:
        - subtasks
      summary: Close all subtasks for session
      operationId: closeSessionSubtasks
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
              properties:
                session_id:
                  type: string
      responses:
        '200':
          description: Subtasks closed

  /api/subtasks/{id}:
    get:
      tags:
        - subtasks
      summary: Get subtask by ID
      operationId: getSubtaskById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Subtask found
        '404':
          description: Subtask not found

    patch:
      tags:
        - subtasks
      summary: Update subtask
      operationId: patchSubtask
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Subtask updated
        '404':
          description: Subtask not found

    delete:
      tags:
        - subtasks
      summary: Delete subtask
      operationId: deleteSubtask
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Subtask deleted
        '404':
          description: Subtask not found

  /api/actions:
    post:
      tags:
        - actions
      summary: Record action
      operationId: postAction
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - agent_id
                - action_type
              properties:
                session_id:
                  type: string
                agent_id:
                  type: string
                action_type:
                  type: string
                payload:
                  type: object
      responses:
        '201':
          description: Action recorded

    get:
      tags:
        - actions
      summary: List actions
      operationId: getActions
      parameters:
        - name: session_id
          in: query
          schema:
            type: string
        - name: agent_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Actions list

  /api/actions/hourly:
    get:
      tags:
        - actions
      summary: Get hourly action statistics
      operationId: getActionsHourly
      parameters:
        - name: session_id
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Hourly stats

  /api/actions/{id}:
    delete:
      tags:
        - actions
      summary: Delete action
      operationId: deleteAction
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Action deleted

  /api/actions/by-session/{session_id}:
    delete:
      tags:
        - actions
      summary: Delete all actions for session
      operationId: deleteActionsBySession
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Actions deleted

  /api/routing/suggest:
    get:
      tags:
        - routing
      summary: Get agent routing suggestion
      operationId: suggestRouting
      parameters:
        - name: session_id
          in: query
          required: true
          schema:
            type: string
        - name: current_agent
          in: query
          schema:
            type: string
        - name: context
          in: query
          schema:
            type: string
      responses:
        '200':
          description: Routing suggestion
          content:
            application/json:
              schema:
                type: object
                properties:
                  suggested_agent:
                    type: string
                  confidence:
                    type: number
                  reason:
                    type: string

  /api/routing/stats:
    get:
      tags:
        - routing
      summary: Get routing statistics
      operationId: getRoutingStats
      responses:
        '200':
          description: Routing stats

  /api/routing/feedback:
    post:
      tags:
        - routing
      summary: Provide routing feedback
      operationId: postRoutingFeedback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - from_agent
                - to_agent
                - success
              properties:
                session_id:
                  type: string
                from_agent:
                  type: string
                to_agent:
                  type: string
                success:
                  type: boolean
                feedback:
                  type: string
      responses:
        '201':
          description: Feedback recorded

  /api/hierarchy/{project_id}:
    get:
      tags:
        - hierarchy
      summary: Get hierarchical view
      operationId: getHierarchy
      parameters:
        - name: project_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Hierarchical structure
          content:
            application/json:
              schema:
                type: object

  /api/active-sessions:
    get:
      tags:
        - hierarchy
      summary: List active sessions
      operationId: getActiveSessions
      responses:
        '200':
          description: Active sessions list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/context/{agent_id}:
    get:
      tags:
        - context
      summary: Get context for agent
      operationId: getContext
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
        - name: session_id
          in: query
          schema:
            type: string
        - name: agent_type
          in: query
          schema:
            type: string
        - name: format
          in: query
          schema:
            type: string
            enum: [brief, raw]
        - name: max_tokens
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Agent context
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Agent not found

  /api/context/generate:
    post:
      tags:
        - context
      summary: Generate context brief
      operationId: postContextGenerate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agent_id
              properties:
                agent_id:
                  type: string
                session_id:
                  type: string
                max_tokens:
                  type: integer
      responses:
        '200':
          description: Generated context

  /api/compact/save:
    post:
      tags:
        - compact
      summary: Save context snapshot (pre-compact)
      operationId: postCompactSave
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - trigger
              properties:
                session_id:
                  type: string
                trigger:
                  type: string
                context_summary:
                  type: string
                active_tasks:
                  type: array
                  items:
                    type: object
                modified_files:
                  type: array
                  items:
                    type: string
                key_decisions:
                  type: array
                  items:
                    type: string
                agent_states:
                  type: object
      responses:
        '201':
          description: Snapshot saved

  /api/compact/restore:
    post:
      tags:
        - compact
      summary: Restore context after compact
      operationId: postCompactRestore
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - agent_id
              properties:
                session_id:
                  type: string
                agent_id:
                  type: string
                agent_type:
                  type: string
                compact_summary:
                  type: string
                max_tokens:
                  type: integer
      responses:
        '200':
          description: Context restored
          content:
            application/json:
              schema:
                type: object
                properties:
                  additionalContext:
                    type: string

  /api/compact/status/{session_id}:
    get:
      tags:
        - compact
      summary: Check compact status
      operationId: getCompactStatus
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Compact status
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_compacted:
                    type: boolean
                  last_compact:
                    type: string
                    format: date-time

  /api/compact/snapshot/{session_id}:
    get:
      tags:
        - compact
      summary: Get compact snapshot
      operationId: getCompactSnapshot
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Snapshot data
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Snapshot not found

  /api/agent-contexts:
    get:
      tags:
        - agent-contexts
      summary: List agent contexts
      operationId: getAgentContexts
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Agent contexts list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/agent-contexts/stats:
    get:
      tags:
        - agent-contexts
      summary: Get agent context statistics
      operationId: getAgentContextsStats
      responses:
        '200':
          description: Context KPIs
          content:
            application/json:
              schema:
                type: object

  /api/sessions:
    post:
      tags:
        - sessions
      summary: Create session
      operationId: postSession
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agent_id
              properties:
                agent_id:
                  type: string
                project_id:
                  type: string
                metadata:
                  type: object
      responses:
        '201':
          description: Session created

    get:
      tags:
        - sessions
      summary: List sessions
      operationId: getSessions
      parameters:
        - name: agent_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Sessions list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

  /api/sessions/stats:
    get:
      tags:
        - sessions
      summary: Get session statistics
      operationId: getSessionsStats
      responses:
        '200':
          description: Session stats
          content:
            application/json:
              schema:
                type: object

  /api/sessions/{id}:
    get:
      tags:
        - sessions
      summary: Get session by ID
      operationId: getSessionById
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Session found
        '404':
          description: Session not found

    patch:
      tags:
        - sessions
      summary: Update session
      operationId: patchSession
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Session updated
        '404':
          description: Session not found

    delete:
      tags:
        - sessions
      summary: Delete session
      operationId: deleteSession
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Session deleted
        '404':
          description: Session not found

  /api/messages:
    post:
      tags:
        - messages
      summary: Post message (broadcast)
      operationId: postMessage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - from_agent
                - to_agent
                - message
              properties:
                from_agent:
                  type: string
                to_agent:
                  type: string
                message:
                  type: string
                session_id:
                  type: string
                metadata:
                  type: object
      responses:
        '201':
          description: Message posted

    get:
      tags:
        - messages
      summary: Get all messages
      operationId: getAllMessages
      parameters:
        - name: session_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Messages list

  /api/messages/{agent_id}:
    get:
      tags:
        - messages
      summary: Get messages for agent
      operationId: getMessages
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Agent messages

  /api/subscribe:
    post:
      tags:
        - subscriptions
      summary: Subscribe to messages
      operationId: postSubscription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subscriber_id
                - publisher_id
              properties:
                subscriber_id:
                  type: string
                publisher_id:
                  type: string
      responses:
        '201':
          description: Subscription created

  /api/subscriptions:
    get:
      tags:
        - subscriptions
      summary: List subscriptions
      operationId: getSubscriptions
      parameters:
        - name: subscriber_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Subscriptions list

  /api/subscriptions/{agent_id}:
    get:
      tags:
        - subscriptions
      summary: Get agent subscriptions
      operationId: getAgentSubscriptions
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Agent subscriptions

    delete:
      tags:
        - subscriptions
      summary: Delete subscription
      operationId: deleteSubscription
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Subscription deleted

  /api/unsubscribe:
    post:
      tags:
        - subscriptions
      summary: Unsubscribe from messages
      operationId: postUnsubscribe
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - subscriber_id
                - publisher_id
              properties:
                subscriber_id:
                  type: string
                publisher_id:
                  type: string
      responses:
        '200':
          description: Unsubscribed

  /api/blocking:
    post:
      tags:
        - blocking
      summary: Block agent
      operationId: postBlocking
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - blocker_id
                - blocked_id
              properties:
                blocker_id:
                  type: string
                blocked_id:
                  type: string
                reason:
                  type: string
      responses:
        '201':
          description: Block created

    get:
      tags:
        - blocking
      summary: List blocks
      operationId: getBlocking
      parameters:
        - name: blocker_id
          in: query
          schema:
            type: string
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Blocks list

  /api/blocking/check:
    get:
      tags:
        - blocking
      summary: Check if agent is blocked
      operationId: checkBlocking
      parameters:
        - name: blocker_id
          in: query
          required: true
          schema:
            type: string
        - name: blocked_id
          in: query
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Block status
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_blocked:
                    type: boolean

  /api/blocking/{agent_id}:
    get:
      tags:
        - blocking
      summary: Get blocks for agent
      operationId: getBlockingByAgent
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Agent blocks

    delete:
      tags:
        - blocking
      summary: Delete block
      operationId: deleteBlocking
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Block deleted

  /api/unblock:
    post:
      tags:
        - blocking
      summary: Unblock agent
      operationId: postUnblock
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - blocker_id
                - blocked_id
              properties:
                blocker_id:
                  type: string
                blocked_id:
                  type: string
      responses:
        '200':
          description: Unblocked

  /api/cleanup/stats:
    get:
      tags:
        - cleanup
      summary: Get cleanup statistics
      operationId: getCleanupStats
      responses:
        '200':
          description: Cleanup stats
          content:
            application/json:
              schema:
                type: object
                properties:
                  last_cleanup:
                    type: object
                  messages:
                    type: object
                  timestamp:
                    type: string
                    format: date-time
        '500':
          description: Failed to get stats

  /stats/tools-summary:
    get:
      tags:
        - tools
      summary: Get tools summary
      operationId: getToolsSummary
      responses:
        '200':
          description: Tools summary
          content:
            application/json:
              schema:
                type: object

  /api/auth/token:
    post:
      tags:
        - auth
      summary: Generate WebSocket auth token
      operationId: postAuthToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agent_id
              properties:
                agent_id:
                  type: string
                session_id:
                  type: string
      responses:
        '200':
          description: Token generated
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                  expires_in:
                    type: integer
        '400':
          description: Invalid parameters
        '500':
          description: Failed to generate token

  /api/tokens/track:
    post:
      tags:
        - tokens
      summary: Track token consumption
      operationId: trackTokens
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agent_id
                - tokens_used
              properties:
                agent_id:
                  type: string
                tokens_used:
                  type: integer
                session_id:
                  type: string
      responses:
        '202':
          description: Tokens tracked

  /api/capacity/{agent_id}:
    get:
      tags:
        - tokens
      summary: Get capacity status
      operationId: getCapacity
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Capacity info
          content:
            application/json:
              schema:
                type: object
                properties:
                  agent_id:
                    type: string
                  tokens_used:
                    type: integer
                  tokens_available:
                    type: integer
                  capacity_percent:
                    type: number

    post:
      tags:
        - tokens
      summary: Reset capacity
      operationId: resetCapacity
      parameters:
        - name: agent_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Capacity reset

  /api/registry:
    get:
      tags:
        - registry
      summary: List all registered agents
      operationId: getRegistry
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
        - name: offset
          in: query
          schema:
            type: integer
      responses:
        '200':
          description: Agents list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

    post:
      tags:
        - registry
      summary: Bulk import agents
      operationId: postRegistryImport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agents
              properties:
                agents:
                  type: array
                  items:
                    type: object
      responses:
        '201':
          description: Agents imported

  /api/registry/{agent_type}:
    get:
      tags:
        - registry
      summary: Get agent scope
      operationId: getRegistryAgent
      parameters:
        - name: agent_type
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Agent scope
        '404':
          description: Agent not found

    put:
      tags:
        - registry
      summary: Upsert agent scope
      operationId: putRegistryAgent
      parameters:
        - name: agent_type
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Agent upserted
        '201':
          description: Agent created

  /api/registry/enrich-context:
    post:
      tags:
        - registry
      summary: Generate enriched context for agent
      operationId: postRegistryEnrichContext
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - agent_type
              properties:
                agent_type:
                  type: string
                context_hints:
                  type: object
      responses:
        '200':
          description: Enriched context

  /api/orchestration/batch-submit:
    post:
      tags:
        - orchestration
      summary: Submit batch of tasks
      operationId: postBatchSubmit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - session_id
                - subtasks
              properties:
                session_id:
                  type: string
                subtasks:
                  type: array
                  items:
                    type: object
      responses:
        '201':
          description: Batch created
          content:
            application/json:
              schema:
                type: object
                properties:
                  batch_id:
                    type: string

  /api/orchestration/batch/{id}:
    get:
      tags:
        - orchestration
      summary: Get batch status
      operationId: getBatch
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Batch info
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Batch not found

    post:
      tags:
        - orchestration
      summary: Complete batch and generate synthesis
      operationId: postBatchComplete
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
      responses:
        '200':
          description: Batch completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  synthesis:
                    type: string

  /api/orchestration/synthesis/{id}:
    get:
      tags:
        - orchestration
      summary: Get synthesis only
      operationId: getSynthesis
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Synthesis
          content:
            application/json:
              schema:
                type: object
                properties:
                  synthesis:
                    type: string
        '404':
          description: Batch not found

  /api/orchestration/conflicts/{id}:
    get:
      tags:
        - orchestration
      summary: Analyze conflicts
      operationId: getConflicts
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Conflicts analysis
          content:
            application/json:
              schema:
                type: object
        '404':
          description: Batch not found

  /api/waves/{session_id}/create:
    post:
      tags:
        - waves
      summary: Create new wave
      operationId: postWaveCreate
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - wave_number
              properties:
                wave_number:
                  type: integer
                description:
                  type: string
      responses:
        '201':
          description: Wave created
          content:
            application/json:
              schema:
                type: object
                properties:
                  wave_id:
                    type: string

  /api/waves/{session_id}/start:
    post:
      tags:
        - waves
      summary: Start wave execution
      operationId: postWaveStart
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - wave_id
              properties:
                wave_id:
                  type: string
      responses:
        '200':
          description: Wave started

  /api/waves/{session_id}/transition:
    post:
      tags:
        - waves
      summary: Force transition to next wave
      operationId: postWaveTransition
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transitioned

  /api/waves/{session_id}/current:
    get:
      tags:
        - waves
      summary: Get current active wave
      operationId: getWaveCurrent
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Current wave
          content:
            application/json:
              schema:
                type: object
        '404':
          description: No active wave

  /api/waves/{session_id}/history:
    get:
      tags:
        - waves
      summary: Get wave history
      operationId: getWaveHistory
      parameters:
        - name: session_id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Wave history
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object

components:
  schemas:
    Error:
      type: object
      required:
        - error
      properties:
        error:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      description: WebSocket token in Authorization header

<svg xmlns="http://www.w3.org/2000/svg" width="1200" height="1000" viewBox="0 0 1200 1000" role="img" aria-label="Full integration lifecycle">
  <defs>
    <style>
      .title { font: 700 28px "Inter", "Segoe UI", Arial, sans-serif; fill: #0f172a; }
      .label { font: 600 15px "Inter", "Segoe UI", Arial, sans-serif; fill: #0f172a; }
      .sub { font: 400 13px "Inter", "Segoe UI", Arial, sans-serif; fill: #334155; }
      .small { font: 400 11px "Inter", "Segoe UI", Arial, sans-serif; fill: #64748b; }
      .phase { font: 700 14px "Inter", "Segoe UI", Arial, sans-serif; fill: #ffffff; }
      .box { fill: #f8fafc; stroke: #94a3b8; stroke-width: 1.5; rx: 10; }
      .box-blue { fill: #eff6ff; stroke: #3b82f6; stroke-width: 1.5; rx: 10; }
      .box-green { fill: #f0fdf4; stroke: #22c55e; stroke-width: 1.5; rx: 10; }
      .box-amber { fill: #fffbeb; stroke: #f59e0b; stroke-width: 1.5; rx: 10; }
      .box-red { fill: #fef2f2; stroke: #ef4444; stroke-width: 1.5; rx: 10; }
      .line { stroke: #64748b; stroke-width: 1.5; marker-end: url(#arrow); }
      .line-dashed { stroke: #94a3b8; stroke-width: 1.5; stroke-dasharray: 5,3; }
      .phase-badge { rx: 8; }
    </style>
    <marker id="arrow" markerWidth="8" markerHeight="8" refX="7" refY="3" orient="auto" markerUnits="strokeWidth">
      <path d="M0,0 L0,6 L8,3 z" fill="#64748b"/>
    </marker>
  </defs>

  <rect x="0" y="0" width="1200" height="1000" fill="#ffffff"/>
  <text x="40" y="42" class="title">Integration Lifecycle</text>
  <text x="40" y="66" class="sub">Complete session lifecycle from startup through compact to shutdown</text>

  <!-- Vertical participant lines -->
  <text x="180" y="105" text-anchor="middle" class="label">Claude Code</text>
  <line x1="180" y1="115" x2="180" y2="960" class="line-dashed"/>

  <text x="400" y="105" text-anchor="middle" class="label">Hooks</text>
  <line x1="400" y1="115" x2="400" y2="960" class="line-dashed"/>

  <text x="620" y="105" text-anchor="middle" class="label">DCM API</text>
  <line x1="620" y1="115" x2="620" y2="960" class="line-dashed"/>

  <text x="840" y="105" text-anchor="middle" class="label">PostgreSQL</text>
  <line x1="840" y1="115" x2="840" y2="960" class="line-dashed"/>

  <text x="1040" y="105" text-anchor="middle" class="label">Dashboard</text>
  <line x1="1040" y1="115" x2="1040" y2="960" class="line-dashed"/>

  <!-- Phase 1: Session Start -->
  <rect x="40" y="130" width="120" height="26" fill="#3b82f6" class="phase-badge"/>
  <text x="100" y="148" text-anchor="middle" class="phase">1. START</text>

  <rect x="120" y="165" width="120" height="30" class="box-blue"/>
  <text x="180" y="184" text-anchor="middle" class="small">SessionStart</text>

  <line x1="240" y1="180" x2="340" y2="180" class="line"/>
  <rect x="340" y="165" width="120" height="30" class="box-blue"/>
  <text x="400" y="184" text-anchor="middle" class="small">ensure-services</text>

  <line x1="460" y1="180" x2="560" y2="180" class="line"/>
  <rect x="560" y="165" width="120" height="30" class="box-blue"/>
  <text x="620" y="184" text-anchor="middle" class="small">GET /health</text>

  <rect x="340" y="205" width="120" height="30" class="box-blue"/>
  <text x="400" y="224" text-anchor="middle" class="small">track-session</text>

  <line x1="460" y1="220" x2="560" y2="220" class="line"/>
  <rect x="560" y="205" width="120" height="30" class="box-blue"/>
  <text x="620" y="224" text-anchor="middle" class="small">POST /api/*</text>

  <line x1="680" y1="220" x2="780" y2="220" class="line"/>
  <rect x="780" y="205" width="120" height="30" class="box"/>
  <text x="840" y="224" text-anchor="middle" class="small">INSERT rows</text>

  <text x="700" y="190" class="small">auto-start if needed</text>
  <text x="700" y="232" class="small">project, session, request, task</text>

  <!-- Phase 2: Tool Usage -->
  <rect x="40" y="260" width="120" height="26" fill="#22c55e" class="phase-badge"/>
  <text x="100" y="278" text-anchor="middle" class="phase">2. TOOLS</text>

  <rect x="100" y="300" width="160" height="24" rx="4" fill="#f0fdf4" stroke="#22c55e" stroke-width="1"/>
  <text x="180" y="316" text-anchor="middle" class="small" style="fill:#22c55e">loop: every tool call</text>

  <rect x="120" y="335" width="120" height="30" class="box-green"/>
  <text x="180" y="354" text-anchor="middle" class="small">PostToolUse(*)</text>

  <line x1="240" y1="350" x2="340" y2="350" class="line"/>
  <rect x="340" y="335" width="120" height="30" class="box-green"/>
  <text x="400" y="354" text-anchor="middle" class="small">track-action</text>

  <line x1="460" y1="350" x2="560" y2="350" class="line"/>
  <rect x="560" y="335" width="120" height="30" class="box-green"/>
  <text x="620" y="354" text-anchor="middle" class="small">POST /actions</text>

  <line x1="680" y1="350" x2="780" y2="350" class="line"/>
  <rect x="780" y="335" width="120" height="30" class="box"/>
  <text x="840" y="354" text-anchor="middle" class="small">INSERT + NOTIFY</text>

  <line x1="900" y1="350" x2="980" y2="350" class="line"/>
  <rect x="980" y="335" width="120" height="30" class="box"/>
  <text x="1040" y="354" text-anchor="middle" class="small">live update</text>

  <!-- Monitor -->
  <rect x="340" y="375" width="120" height="30" class="box-green"/>
  <text x="400" y="394" text-anchor="middle" class="small">monitor-context</text>
  <text x="500" y="394" class="small">every 10th call</text>

  <!-- Track agent (Task only) -->
  <rect x="120" y="415" width="120" height="30" class="box-green"/>
  <text x="180" y="434" text-anchor="middle" class="small">PostToolUse(Task)</text>

  <line x1="240" y1="430" x2="340" y2="430" class="line"/>
  <rect x="340" y="415" width="120" height="30" class="box-green"/>
  <text x="400" y="434" text-anchor="middle" class="small">track-agent</text>

  <line x1="460" y1="430" x2="560" y2="430" class="line"/>
  <rect x="560" y="415" width="120" height="30" class="box-green"/>
  <text x="620" y="434" text-anchor="middle" class="small">POST /subtasks</text>

  <!-- Phase 3: Subagent Complete -->
  <rect x="40" y="470" width="120" height="26" fill="#f59e0b" class="phase-badge"/>
  <text x="100" y="488" text-anchor="middle" class="phase">3. AGENT</text>

  <rect x="120" y="510" width="120" height="30" class="box-amber"/>
  <text x="180" y="529" text-anchor="middle" class="small">SubagentStop</text>

  <line x1="240" y1="525" x2="340" y2="525" class="line"/>
  <rect x="340" y="510" width="140" height="30" class="box-amber"/>
  <text x="410" y="529" text-anchor="middle" class="small">save-agent-result</text>

  <line x1="480" y1="520" x2="560" y2="520" class="line"/>
  <rect x="560" y="505" width="130" height="30" class="box-amber"/>
  <text x="625" y="524" text-anchor="middle" class="small">POST /messages</text>

  <line x1="480" y1="530" x2="560" y2="545" class="line"/>
  <rect x="560" y="540" width="130" height="30" class="box-amber"/>
  <text x="625" y="559" text-anchor="middle" class="small">PATCH /subtasks</text>

  <text x="700" y="524" class="small">broadcast result</text>
  <text x="700" y="559" class="small">mark completed</text>

  <!-- Phase 4: Compact -->
  <rect x="40" y="590" width="120" height="26" fill="#ef4444" class="phase-badge"/>
  <text x="100" y="608" text-anchor="middle" class="phase">4. COMPACT</text>

  <!-- Pre-compact save -->
  <rect x="120" y="630" width="120" height="30" class="box-red"/>
  <text x="180" y="649" text-anchor="middle" class="small">PreCompact</text>

  <line x1="240" y1="645" x2="340" y2="645" class="line"/>
  <rect x="340" y="630" width="150" height="30" class="box-red"/>
  <text x="415" y="649" text-anchor="middle" class="small">pre-compact-save</text>

  <line x1="490" y1="645" x2="560" y2="645" class="line"/>
  <rect x="560" y="630" width="140" height="30" class="box-red"/>
  <text x="630" y="649" text-anchor="middle" class="small">compact/save</text>

  <line x1="700" y1="645" x2="780" y2="645" class="line"/>
  <rect x="780" y="630" width="120" height="30" class="box"/>
  <text x="840" y="649" text-anchor="middle" class="small">UPSERT snapshot</text>

  <!-- Compact happens -->
  <rect x="100" y="680" width="320" height="26" rx="4" fill="#fef2f2" stroke="#ef4444" stroke-width="1"/>
  <text x="260" y="697" text-anchor="middle" class="small" style="fill:#ef4444">... Claude compacts the conversation ...</text>

  <!-- Post-compact restore -->
  <rect x="120" y="720" width="160" height="30" class="box-red"/>
  <text x="200" y="739" text-anchor="middle" class="small">SessionStart(compact)</text>

  <line x1="280" y1="735" x2="340" y2="735" class="line"/>
  <rect x="340" y="720" width="175" height="30" class="box-red"/>
  <text x="427" y="739" text-anchor="middle" class="small">post-compact-restore</text>

  <line x1="515" y1="735" x2="560" y2="735" class="line"/>
  <rect x="560" y="720" width="140" height="30" class="box-red"/>
  <text x="630" y="739" text-anchor="middle" class="small">compact/restore</text>

  <line x1="700" y1="735" x2="780" y2="735" class="line"/>
  <rect x="780" y="720" width="120" height="30" class="box"/>
  <text x="840" y="739" text-anchor="middle" class="small">fetch context</text>

  <!-- Return to Claude -->
  <line x1="560" y1="755" x2="240" y2="780" style="stroke:#ef4444;stroke-width:1.5;stroke-dasharray:5,3;marker-end:url(#arrow)"/>
  <rect x="120" y="770" width="200" height="30" class="box-red"/>
  <text x="220" y="789" text-anchor="middle" class="small">additionalContext injected</text>

  <!-- Phase 5: Session End -->
  <rect x="40" y="820" width="120" height="26" fill="#64748b" class="phase-badge"/>
  <text x="100" y="838" text-anchor="middle" class="phase">5. END</text>

  <rect x="120" y="860" width="120" height="30" class="box"/>
  <text x="180" y="879" text-anchor="middle" class="small">SessionEnd</text>

  <line x1="240" y1="875" x2="340" y2="875" class="line"/>
  <rect x="340" y="860" width="155" height="30" class="box"/>
  <text x="417" y="879" text-anchor="middle" class="small">track-session-end</text>

  <line x1="495" y1="875" x2="560" y2="875" class="line"/>
  <rect x="560" y="860" width="150" height="30" class="box"/>
  <text x="635" y="879" text-anchor="middle" class="small">PATCH /sessions</text>

  <text x="720" y="879" class="small">set ended_at, cleanup cache</text>

  <!-- Timeline arrow -->
  <line x1="20" y1="130" x2="20" y2="960" stroke="#e2e8f0" stroke-width="2"/>
  <text x="24" y="970" class="small">time</text>
</svg>
